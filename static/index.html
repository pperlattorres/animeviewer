<!DOCTYPE html>
<html lang="es" style="color-scheme: dark;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0d0d14" />
  <title>JOANG Anime</title>
  <style>
    /* ── Reset & tokens ─────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d0d14;
      --surface:   #181824;
      --surface2:  #22223a;
      --surface3:  #2a2a45;
      --accent:    #7c6af7;
      --accent2:   #a78bfa;
      --text:      #e2e1f0;
      --muted:     #7b7a9c;
      --border:    #2e2e4a;
      --radius:    10px;
      --radius-lg: 16px;
      --fs-xs:  .72rem;  --fs-sm:  .82rem;
      --fs-base:.95rem;  --fs-lg:  1.15rem;
      --fs-xl:  1.45rem; --fs-2xl: 2rem;
      --fs-3xl: 2.8rem;
      --hit:    44px;
      --header-h: 64px;
    }

    @media (min-width: 1920px) {
      :root {
        --fs-xs:1rem; --fs-sm:1.15rem; --fs-base:1.3rem;
        --fs-lg:1.6rem; --fs-xl:2rem; --fs-2xl:2.6rem; --fs-3xl:3.8rem;
        --hit:72px; --header-h:88px; --radius:14px; --radius-lg:22px;
      }
    }

    html, body {
      min-height: 100%;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: var(--fs-base);
    }

    :focus-visible {
      outline: 2px solid var(--accent2);
      outline-offset: 2px;
      border-radius: var(--radius);
    }

    .skip-link {
      position: absolute; top: -100%; left: 8px; z-index: 9999;
      padding: 8px 16px; border-radius: var(--radius);
      background: var(--accent); color: #fff;
      font-weight: 700; text-decoration: none;
    }
    .skip-link:focus { top: 8px; }

    /* ── Views ─────────────────────────────────── */
    .view { display: none; }
    .view.active { display: block; }

    /* ── Header ────────────────────────────────── */
    .site-header {
      position: sticky; top: 0; z-index: 200;
      height: var(--header-h);
      background: rgba(13,13,20,.95);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: 0 max(24px, env(safe-area-inset-left));
      padding-right: max(24px, env(safe-area-inset-right));
      display: flex; align-items: center; gap: 16px;
    }
    .logo {
      font-size: var(--fs-xl); font-weight: 900;
      color: var(--accent2); white-space: nowrap; flex-shrink: 0;
      letter-spacing: -.03em; cursor: pointer;
      background: none; border: none; padding: 0; color: var(--accent2);
      font: inherit; font-size: var(--fs-xl); font-weight: 900;
    }
    .logo:hover { color: #fff; }
    .logo span { color: var(--accent); }

    .header-search {
      flex: 1; max-width: 560px;
      display: flex; gap: 8px;
    }
    .header-search input {
      flex: 1; min-height: calc(var(--header-h) - 20px);
      padding: 0 16px; border-radius: var(--radius);
      background: var(--surface2); border: 1.5px solid var(--border);
      color: var(--text); font-size: var(--fs-sm);
      transition: border-color .2s;
      touch-action: manipulation;
    }
    .header-search input:focus {
      border-color: var(--accent); outline: none;
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 28%, transparent);
    }
    .header-search input::placeholder { color: var(--muted); }

    /* ── Buttons ───────────────────────────────── */
    .btn {
      min-height: var(--hit); padding: 0 24px;
      border-radius: var(--radius);
      background: var(--accent); color: #fff; border: none;
      font-size: var(--fs-sm); font-weight: 700; cursor: pointer;
      transition: background .2s, transform .1s, opacity .2s;
      touch-action: manipulation; white-space: nowrap;
    }
    .btn:hover { background: var(--accent2); }
    .btn:active { transform: scale(.97); }
    .btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }

    .btn-ghost {
      min-height: var(--hit); padding: 0 18px;
      border-radius: var(--radius);
      background: transparent; color: var(--muted);
      border: 1.5px solid var(--border);
      font-size: var(--fs-sm); font-weight: 600; cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      transition: color .2s, border-color .2s, background .2s;
      touch-action: manipulation; white-space: nowrap;
    }
    .btn-ghost:hover { color: var(--text); border-color: var(--accent2); background: var(--surface2); }

    /* ── Badges ────────────────────────────────── */
    .badge {
      display: inline-flex; align-items: center;
      padding: 3px 10px; border-radius: 20px;
      font-size: var(--fs-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: .04em;
    }
    .badge-accent  { background: rgba(124,106,247,.2); color: var(--accent2); }
    .badge-surface { background: var(--surface3); color: var(--muted); }
    .badge-star    { background: rgba(251,191,36,.15); color: #fbbf24; }

    /* ── Spinner ───────────────────────────────── */
    .spinner {
      display: inline-block; width: 18px; height: 18px;
      border: 2.5px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin .7s linear infinite;
      vertical-align: middle; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (prefers-reduced-motion:reduce) {
      .spinner { animation:none; opacity:.7; }
      * { transition-duration:0s !important; }
    }

    /* ── Misc ──────────────────────────────────── */
    .empty-msg {
      display: flex; align-items: center; justify-content: center;
      gap: 10px; padding: 48px 24px;
      color: var(--muted); font-size: var(--fs-sm); text-align: center;
    }
    .error-box {
      padding: 16px 20px; border-radius: var(--radius);
      background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.35);
      color: #fca5a5; font-size: var(--fs-sm);
    }
    .sr-only {
      position: absolute; width: 1px; height: 1px;
      overflow: hidden; clip: rect(0 0 0 0); white-space: nowrap;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* ═══════════════════════════════════════════
       HOME VIEW
    ═══════════════════════════════════════════ */
    #viewHome {
      min-height: 100dvh;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 40px 24px max(40px, env(safe-area-inset-bottom));
      position: relative; overflow: hidden;
    }
    #viewHome::before {
      content: '';
      position: absolute; inset: 0; z-index: 0;
      background:
        radial-gradient(ellipse 80% 55% at 50% -5%, rgba(124,106,247,.26) 0%, transparent 70%),
        radial-gradient(ellipse 55% 40% at 85% 105%, rgba(167,139,250,.12) 0%, transparent 60%);
      pointer-events: none;
    }
    .home-content {
      position: relative; z-index: 1;
      display: flex; flex-direction: column;
      align-items: center; gap: 28px;
      width: 100%; max-width: 1100px;
    }
    .home-logo {
      font-size: clamp(2.4rem, 8vw, var(--fs-3xl));
      font-weight: 900; letter-spacing: -.04em;
      text-align: center; user-select: none;
    }
    .home-logo .hl { color: var(--accent2); }
    .home-logo .dot { color: var(--accent); }
    .home-tagline {
      font-size: var(--fs-lg); color: var(--muted);
      text-align: center; text-wrap: balance;
      margin-top: -16px;
    }
    .home-search-form {
      width: 100%; max-width: 680px;
      display: flex; gap: 10px;
    }
    .home-search-input {
      flex: 1; min-height: 56px; padding: 0 22px;
      border-radius: var(--radius-lg);
      background: var(--surface); border: 1.5px solid var(--border);
      color: var(--text); font-size: var(--fs-base);
      transition: border-color .2s, box-shadow .2s;
      touch-action: manipulation;
    }
    .home-search-input:focus {
      border-color: var(--accent); outline: none;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 28%, transparent);
    }
    .home-search-input::placeholder { color: var(--muted); }
    .home-search-btn {
      min-height: 56px; padding: 0 28px;
      border-radius: var(--radius-lg);
      background: var(--accent); color: #fff; border: none;
      font-size: var(--fs-base); font-weight: 700; cursor: pointer;
      transition: background .2s, transform .1s;
      touch-action: manipulation;
    }
    .home-search-btn:hover { background: var(--accent2); }
    .home-search-btn:active { transform: scale(.97); }
    .home-search-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    @media (max-width: 479px) {
      .home-search-form { flex-direction: column; }
      .home-search-btn { min-height: 50px; width: 100%; }
    }
    @media (min-width: 1920px) {
      .home-search-input { min-height: 80px; font-size: var(--fs-lg); border-radius: 20px; }
      .home-search-btn   { min-height: 80px; font-size: var(--fs-lg); border-radius: 20px; }
    }

    /* ── Home sections (history / latest eps / latest animes) ── */
    .history-section,
    .latest-section {
      width: 100%; margin-top: 8px;
    }
    .history-title,
    .latest-section-title {
      font-size: var(--fs-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: .1em;
      color: var(--muted); margin-bottom: 14px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .history-clear {
      background: none; border: none; color: var(--muted);
      font-size: var(--fs-xs); cursor: pointer; padding: 4px 8px;
      border-radius: var(--radius); transition: color .2s;
      font-family: inherit;
    }
    .history-clear:hover { color: #f87171; }

    /* shared grid for all 3 home sections */
    .history-grid,
    .latest-scroll {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
    }

    /* shared card base */
    .history-card,
    .latest-ep-card,
    .latest-anime-card {
      position: relative; display: flex; flex-direction: column;
      width: 100%;
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
      cursor: pointer; text-align: left;
      transition: transform .18s, border-color .2s, box-shadow .2s;
      touch-action: manipulation;
      font: inherit; color: inherit;
    }
    .history-card:hover,
    .latest-ep-card:hover,
    .latest-anime-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 8px 28px rgba(124,106,247,.25);
    }

    /* poster / thumb images — all 2:3 portrait */
    .history-card-poster,
    .latest-ep-thumb,
    .latest-anime-poster {
      width: 100%; aspect-ratio: 2 / 3;
      object-fit: cover; display: block;
      background: var(--surface2);
    }

    /* card bodies */
    .history-card-body,
    .latest-ep-body,
    .latest-anime-body {
      padding: 8px 10px 10px;
      display: flex; flex-direction: column; gap: 4px;
    }

    /* titles inside cards */
    .history-card-title,
    .latest-ep-title,
    .latest-anime-title {
      font-size: var(--fs-xs); font-weight: 700; line-height: 1.3;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* episode / type badges */
    .history-ep-badge,
    .latest-ep-badge {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: .68rem; font-weight: 700;
      color: var(--accent2); margin-top: 2px;
    }
    .history-ep-badge svg { flex-shrink: 0; }

    .latest-loading {
      font-size: var(--fs-xs); color: var(--muted); padding: 8px 0;
      grid-column: 1 / -1;
    }
    .latest-error {
      grid-column: 1 / -1;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 0;
    }
    .latest-error-msg {
      font-size: var(--fs-xs); color: var(--muted);
    }
    .latest-retry-btn {
      font-size: var(--fs-xs); font-weight: 700;
      padding: 5px 14px; border-radius: var(--radius);
      background: var(--surface2); border: 1.5px solid var(--border);
      color: var(--text); cursor: pointer; font-family: inherit;
      transition: border-color .2s, background .2s;
      touch-action: manipulation;
    }
    .latest-retry-btn:hover { border-color: var(--accent); background: var(--surface); }

    @media (min-width: 1920px) {
      .history-grid,
      .latest-scroll { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 18px; }
    }
    @media (max-width: 479px) {
      .history-grid,
      .latest-scroll { grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 10px; }
    }

    /* ═══════════════════════════════════════════
       RESULTS VIEW
    ═══════════════════════════════════════════ */
    #viewResults {
      min-height: calc(100dvh - var(--header-h));
      display: flex; flex-direction: column; align-items: center;
    }

    .results-container {
      width: 100%; max-width: 1600px;
      padding: 0 32px;
    }

    .results-bar {
      padding: 24px 0 14px;
      display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap;
    }
    .results-bar h2 { font-size: var(--fs-xl); font-weight: 800; }
    .results-bar .count { font-size: var(--fs-sm); color: var(--muted); }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
      padding: 0 0 48px;
    }

    .anime-card {
      display: flex; flex-direction: column;
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: var(--radius-lg); overflow: hidden;
      cursor: pointer; text-align: left; position: relative;
      transition: transform .18s, border-color .2s, box-shadow .2s;
      touch-action: manipulation;
      font: inherit; color: inherit; width: 100%;
    }
    .anime-card:hover {
      transform: translateY(-5px);
      border-color: var(--accent);
      box-shadow: 0 10px 36px rgba(124,106,247,.28);
    }
    .anime-card:active { transform: translateY(-2px); }
    .anime-card.active { border-color: var(--accent2); box-shadow: 0 0 0 2px var(--accent); }
    .anime-card-poster {
      width: 100%; aspect-ratio: 2 / 3;
      object-fit: cover; display: block;
      background: var(--surface2);
    }
    .anime-card-body { padding: 12px 12px 14px; display: flex; flex-direction: column; gap: 7px; }
    .anime-card-title {
      font-size: var(--fs-sm); font-weight: 700; line-height: 1.35;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; text-wrap: pretty;
    }
    .anime-card-meta { display: flex; flex-wrap: wrap; gap: 5px; }

    /* Card wrapper + fav overlay */
    .card-wrap { position: relative; }
    .card-fav-btn {
      position: absolute; top: 8px; right: 8px; z-index: 3;
      width: 34px; height: 34px; border-radius: 50%;
      background: rgba(13,13,20,.72); backdrop-filter: blur(8px);
      border: 1.5px solid rgba(255,255,255,.15);
      color: var(--muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: color .18s, background .18s, border-color .18s, transform .15s;
      font: inherit; flex-shrink: 0;
    }
    .card-fav-btn:hover { color: #f87171; border-color: #f87171; transform: scale(1.12); }
    .card-fav-btn.active { color: #f87171; background: rgba(248,113,113,.22); border-color: #f87171; }

    /* Home fav button (next to Buscar) */
    .home-fav-btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 7px;
      min-height: 52px; padding: 0 22px;
      background: var(--surface2); border: 1.5px solid var(--border);
      border-radius: var(--radius-lg); color: var(--text);
      cursor: pointer; font: 700 var(--fs-base)/1 inherit;
      transition: border-color .18s, color .18s; white-space: nowrap; flex-shrink: 0;
    }
    .home-fav-btn:hover { border-color: #f87171; color: #f87171; }
    .home-fav-btn.has-favs { color: #f87171; border-color: rgba(248,113,113,.45); }

    @media (min-width: 1920px) {
      .results-container { padding: 0 64px; }
      .results-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 28px; padding: 0 0 64px; }
      .results-bar  { padding: 40px 0 20px; }
    }
    @media (max-width: 639px) {
      .results-container { padding: 0 16px; }
      .results-grid { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 14px; padding: 0 0 36px; }
      .results-bar  { padding: 18px 0 10px; }
    }

    /* ═══════════════════════════════════════════
       ANIME DETAIL VIEW
    ═══════════════════════════════════════════ */
    #viewAnime { min-height: calc(100dvh - var(--header-h)); }

    /* Hero */
    .anime-hero {
      position: relative;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }
    .anime-hero-bg {
      position: absolute; inset: 0; z-index: 0;
      background-size: cover; background-position: center;
      filter: blur(28px) brightness(.3) saturate(1.4);
      transform: scale(1.1);
    }
    .anime-hero-inner {
      position: relative; z-index: 1;
      display: flex; gap: 28px; padding: 28px max(32px, env(safe-area-inset-left)) 28px;
      align-items: flex-start;
    }
    .anime-hero-poster {
      width: 150px; flex-shrink: 0;
      aspect-ratio: 2 / 3; object-fit: cover;
      border-radius: var(--radius-lg);
      box-shadow: 0 12px 44px rgba(0,0,0,.65);
      background: var(--surface2);
    }
    .anime-hero-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 14px; }
    .hero-resume-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .hero-resume-label { font-size: var(--fs-xs); color: var(--muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: .08em; white-space: nowrap; }
    .hero-resume-btn {
      display: inline-flex; align-items: center; gap: 7px;
      background: var(--accent2); color: #fff;
      border: none; border-radius: var(--radius); cursor: pointer;
      font: 700 var(--fs-sm)/1 inherit;
      padding: 8px 16px;
      transition: opacity .18s, transform .15s;
      white-space: nowrap;
    }
    .hero-resume-btn:hover { opacity: .85; transform: scale(1.03); }
    .hero-resume-btn svg { flex-shrink: 0; }

    /* Hero actions row (fav + resume) */
    .hero-actions-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .hero-fav-btn {
      display: inline-flex; align-items: center; gap: 7px;
      border: 1.5px solid var(--border); border-radius: var(--radius);
      background: var(--surface2); color: var(--text);
      cursor: pointer; font: 700 var(--fs-sm)/1 inherit;
      padding: 8px 16px; min-height: 36px;
      transition: background .18s, border-color .18s, color .18s;
    }
    .hero-fav-btn:hover { border-color: #f87171; color: #f87171; }
    .hero-fav-btn.active { background: rgba(248,113,113,.15); border-color: #f87171; color: #f87171; }
    .hero-fav-btn svg { flex-shrink: 0; transition: fill .18s; }
    .anime-hero-title {
      font-size: clamp(1.35rem, 3.5vw, var(--fs-2xl));
      font-weight: 900; line-height: 1.15; text-wrap: balance;
    }
    .anime-badges { display: flex; flex-wrap: wrap; gap: 8px; }
    .anime-synopsis {
      font-size: var(--fs-sm); color: rgba(226,225,240,.8); line-height: 1.7;
      max-width: 700px;
      display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .anime-genres { display: flex; flex-wrap: wrap; gap: 6px; }

    @media (min-width: 1920px) {
      .anime-hero-poster { width: 210px; }
      .anime-hero-inner  { padding: 44px 64px; gap: 36px; }
    }
    @media (max-width: 639px) {
      .anime-hero-inner  { flex-direction: column; padding: 18px 16px; gap: 18px; }
      .anime-hero-poster { width: 110px; }
      .anime-hero-title  { font-size: 1.3rem; }
    }

    /* Episodes */
    .episodes-section { padding: 28px 32px 24px; }
    .section-title {
      font-size: var(--fs-lg); font-weight: 800;
      margin-bottom: 16px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .section-title .count { font-size: var(--fs-sm); font-weight: 400; color: var(--muted); }
    .ep-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .ep-btn {
      min-width: var(--hit); min-height: calc(var(--hit) * .85);
      padding: 0 16px; border-radius: var(--radius);
      font-size: var(--fs-sm); font-weight: 700;
      font-variant-numeric: tabular-nums;
      background: var(--surface2); border: 1.5px solid var(--border);
      color: var(--text); cursor: pointer; position: relative; overflow: hidden;
      transition: background .15s, border-color .15s, color .15s, transform .1s;
      touch-action: manipulation;
    }
    .ep-btn:hover  { background: var(--surface3); border-color: var(--accent); color: var(--accent2); }
    .ep-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; transform: scale(1.05); }
    .ep-btn.has-progress { border-color: rgba(167,139,250,.5); }
    .ep-btn-progress {
      position: absolute; bottom: 0; left: 0; height: 3px;
      background: var(--accent2); border-radius: 0 2px 0 0;
      pointer-events: none; transition: width .4s;
    }
    .ep-btn.active .ep-btn-progress { background: rgba(255,255,255,.6); }

    /* ── Progress toast ───────────────────── */
    .progress-toast {
      position: fixed; bottom: 28px; left: 50%;
      transform: translateX(-50%);
      z-index: 9998;
      background: var(--surface2); border: 1px solid var(--accent);
      border-radius: var(--radius-lg); padding: 14px 18px;
      display: flex; align-items: center; gap: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,.55);
      max-width: min(480px, calc(100vw - 32px));
      animation: toastIn .22s ease-out;
      transition: opacity .22s, transform .22s;
    }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(-50%) translateY(14px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .toast-msg { font-size: var(--fs-sm); font-weight: 600; flex: 1; line-height: 1.4; }
    .toast-msg strong { color: var(--accent2); }
    .toast-progress-bar-wrap {
      width: 100%; height: 4px; background: var(--surface3);
      border-radius: 4px; margin-top: 7px; overflow: hidden;
    }
    .toast-progress-bar { height: 100%; background: var(--accent2); border-radius: 4px; transition: width .4s; }
    .toast-close {
      background: none; border: none; color: var(--muted);
      cursor: pointer; font: inherit; font-size: 1rem; line-height: 1;
      padding: 4px; border-radius: var(--radius); transition: color .15s;
      flex-shrink: 0;
    }
    .toast-close:hover { color: var(--text); }

    @media (min-width: 1920px) {
      .episodes-section { padding: 40px 64px 32px; }
      .ep-btn { min-height: var(--hit); padding: 0 20px; }
    }
    @media (max-width: 639px) { .episodes-section { padding: 20px 16px; } }

    /* Player */
    .player-section {
      margin: 0 32px 40px;
      border: 1px solid var(--border); border-radius: var(--radius-lg);
      overflow: hidden; background: var(--surface);
    }
    .player-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 10px;
      background: var(--surface2);
    }
    .player-ep-label {
      font-size: var(--fs-sm); font-weight: 700; color: var(--text);
      display: flex; align-items: center; gap: 8px;
    }
    .server-bar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .server-label {
      font-size: var(--fs-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: .08em; color: var(--muted);
    }
    .server-btn {
      min-height: calc(var(--hit) * .75); padding: 0 16px;
      border-radius: var(--radius); font-size: var(--fs-sm); font-weight: 600;
      background: var(--surface3); border: 1.5px solid var(--border);
      color: var(--text); cursor: pointer;
      transition: background .15s, border-color .15s, color .15s;
      touch-action: manipulation;
    }
    .server-btn:hover  { background: var(--surface); border-color: var(--accent); color: var(--accent2); }
    .server-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* Episode wall-clock timer */
    .ep-timer {
      font-size: var(--fs-xs); font-variant-numeric: tabular-nums;
      color: var(--accent2); font-weight: 700; letter-spacing: .04em;
      background: rgba(167,139,250,.12); border-radius: 6px;
      padding: 2px 8px; margin-left: 8px;
    }
    .player-body {
      width: 100%; aspect-ratio: 16 / 9;
      background: #000; display: flex; align-items: center; justify-content: center;
    }
    .player-body iframe { width: 100%; height: 100%; border: none; display: block; }
    .direct-player {
      width: 100%; height: 100%; display: block; background: #000;
      /* Reset browser default outline / margin */
      outline: none; margin: 0;
    }
    .extract-badge {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: var(--fs-xs); font-weight: 700;
      color: #4ade80; background: rgba(74,222,128,.12);
      border-radius: 6px; padding: 2px 8px; margin-left: 6px;
    }
    .extract-badge.fallback { color: var(--muted); background: rgba(255,255,255,.06); }
    .player-placeholder {
      color: var(--muted); font-size: var(--fs-base);
      text-align: center; line-height: 2; padding: 24px;
    }
    .player-placeholder svg {
      display: block; margin: 0 auto 12px; opacity: .2;
      width: clamp(48px, 6vw, 80px); height: auto;
    }

    @media (min-width: 1920px) { .player-section { margin: 0 64px 56px; } }
    @media (max-width: 639px) { .player-section { margin: 0 16px 32px; } }

    /* Dubbed */
    .dubbed-toggle {
      display: flex; align-items: center; gap: 8px;
      font-size: var(--fs-sm); cursor: pointer;
      min-height: var(--hit); padding: 0 2px;
      white-space: nowrap; user-select: none; flex-shrink: 0;
    }
    .dubbed-toggle input { accent-color: var(--accent); width: 18px; height: 18px; cursor: pointer; }

    /* Header fav button */
    .header-fav-btn {
      display: flex; align-items: center; justify-content: center;
      min-width: var(--hit); min-height: var(--hit);
      background: none; border: none; cursor: pointer;
      color: var(--muted); border-radius: var(--radius);
      transition: color .2s; flex-shrink: 0; font: inherit;
      padding: 0 8px;
    }
    .header-fav-btn:hover { color: #f87171; }
    .header-fav-btn.has-favs { color: #f87171; }

    /* ── Debug log panel ───────────────────── */
    .debug-panel {
      margin: 0 32px 32px;
      border: 1px solid var(--border); border-radius: var(--radius);
      overflow: hidden; font-family: 'Cascadia Code', 'Consolas', monospace;
    }
    @media (max-width:639px) { .debug-panel { margin: 0 16px 24px; } }
    @media (min-width:1920px) { .debug-panel { margin: 0 64px 48px; } }
    .debug-toggle {
      width: 100%; display: flex; gap: 10px; align-items: center;
      padding: 10px 16px; background: var(--surface2); border: none;
      color: var(--muted); font-size: var(--fs-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: .1em; cursor: pointer;
      text-align: left; transition: color .2s;
    }
    .debug-toggle:hover { color: var(--text); }
    .debug-toggle .arrow { transition: transform .2s; display: inline-block; }
    .debug-toggle.open .arrow { transform: rotate(90deg); }
    .debug-log {
      max-height: 220px; overflow-y: auto;
      background: #0a0a10; padding: 10px 16px;
      display: none;
    }
    .debug-log.open { display: block; }
    .log-line {
      display: flex; gap: 12px; padding: 3px 0;
      border-bottom: 1px solid rgba(46,46,74,.5);
      font-size: .78rem; line-height: 1.5;
    }
    .log-line:last-child { border-bottom: none; }
    .log-ts   { color: #4a4a6a; white-space: nowrap; flex-shrink: 0; }
    .log-lvl  { font-weight: 700; flex-shrink: 0; min-width: 52px; }
    .log-msg  { color: #a0a0c0; word-break: break-all; }
    .log-ok   { color: #4ade80; }
    .log-warn { color: #fbbf24; }
    .log-err  { color: #f87171; }
    .log-info { color: #60a5fa; }

    /* ── Favorites view ────────────────────── */
    #viewFavs {
      min-height: calc(100dvh - var(--header-h));
      display: flex; flex-direction: column; align-items: center;
    }
    .favs-empty {
      width: 100%; text-align: center; padding: 80px 24px;
      color: var(--muted); font-size: var(--fs-lg);
    }
    .favs-empty svg { display: block; margin: 0 auto 16px; opacity: .18; }
    .favs-bar-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-left: auto; }
    .btn-danger {
      padding: 6px 14px; border-radius: var(--radius);
      background: none; border: 1.5px solid rgba(248,113,113,.4);
      color: #f87171; cursor: pointer; font: inherit; font-size: var(--fs-xs); font-weight: 700;
      transition: background .18s, border-color .18s;
    }
    .btn-danger:hover { background: rgba(248,113,113,.12); border-color: #f87171; }
  </style>
</head>
<body>

<a href="#main" class="skip-link">Saltar al contenido</a>

<!-- ════════════════════════════════════════
     HEADER (oculto en home)
════════════════════════════════════════ -->
<header class="site-header" id="siteHeader" style="display:none;" role="banner">
  <button class="logo" type="button" onclick="goHome()" aria-label="JOANG Anime — Inicio">
    JOANG<span> Anime</span>
  </button>

  <form class="header-search" role="search"
    onsubmit="event.preventDefault(); doSearch(document.getElementById('headerInput').value)">
    <label class="sr-only" for="headerInput">Buscar anime</label>
    <input id="headerInput" type="search" placeholder="Buscar anime…"
      autocomplete="off" spellcheck="false" />
    <button class="btn" id="headerBtn" type="submit">Buscar</button>
  </form>

  <label class="dubbed-toggle">
    <input type="checkbox" id="dubbedCheck" aria-label="Activar doblaje LAT" />
    LAT
  </label>

  <button class="header-fav-btn" id="headerFavBtn" type="button"
    onclick="showFavs()" aria-label="Mis favoritos">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
  </button>
</header>

<!-- ════════════════════════════════════════
     VIEW: HOME
════════════════════════════════════════ -->
<div id="viewHome" class="view active" role="main" id="main">
  <div class="home-content">
    <h1 class="home-logo">JOANG<span class="hl"> Anime</span><span class="dot">.</span></h1>
    <p class="home-tagline">Busca tu anime favorito y empieza a ver ahora</p>

    <form class="home-search-form" role="search"
      onsubmit="event.preventDefault(); doSearch(document.getElementById('homeInput').value)">
      <label class="sr-only" for="homeInput">Buscar anime</label>
      <input id="homeInput" class="home-search-input" type="search"
        placeholder="Ej: Nanatsu no Taizai, Attack on Titan…"
        autocomplete="off" spellcheck="false" autofocus />
      <button class="home-search-btn" id="homeBtn" type="submit">Buscar</button>
      <button class="home-fav-btn" id="homeFavBtn" type="button" onclick="showFavs()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
        Favoritos
      </button>
    </form>

    <!-- Historial -->
    <div class="history-section" id="historySection" style="display:none;">
      <div class="history-title">
        <span>Vistos recientemente</span>
        <button class="history-clear" type="button" onclick="historyClear()" aria-label="Borrar historial">Borrar</button>
      </div>
      <div class="history-grid" id="historyGrid"></div>
    </div>

    <!-- Últimos episodios -->
    <div class="latest-section" id="latestEpSection" style="display:none;">
      <div class="latest-section-title">Últimos episodios</div>
      <div class="latest-scroll" id="latestEpGrid"></div>
    </div>

    <!-- Últimos animes -->
    <div class="latest-section" id="latestAnimeSection" style="display:none;">
      <div class="latest-section-title">Últimos animes</div>
      <div class="latest-scroll" id="latestAnimeGrid"></div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════
     VIEW: RESULTADOS
════════════════════════════════════════ -->
<div id="viewResults" class="view" role="main">
  <div class="results-container">
    <div class="results-bar">
      <h2 id="resultsTitle">Resultados</h2>
      <span class="count" id="resultsCount" aria-live="polite"></span>
    </div>
    <div id="resultsGrid" class="results-grid" role="list"
      aria-live="polite" aria-label="Resultados de búsqueda"></div>

    <!-- Debug log -->
    <div class="debug-panel" id="debugPanel">
      <button class="debug-toggle" type="button" id="debugToggle"
        aria-expanded="false" aria-controls="debugLog"
        onclick="toggleDebug()">
        <span class="arrow">&#9654;</span>
        Consola de depuración
        <span id="debugBadge" style="margin-left:auto;padding:1px 8px;border-radius:10px;background:var(--surface3);font-size:.7rem;">0</span>
      </button>
      <div class="debug-log" id="debugLog" role="log" aria-live="off"></div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════
     VIEW: ANIME DETAIL
════════════════════════════════════════ -->
<div id="viewAnime" class="view" role="main">

  <section class="anime-hero" aria-label="Información del anime">
    <div class="anime-hero-bg" id="animeBg" aria-hidden="true"></div>
    <div class="anime-hero-inner">
      <img class="anime-hero-poster" id="animePoster" src="" alt="" width="150" height="225" />
      <div class="anime-hero-info">
        <button class="btn-ghost" type="button" onclick="goBack()" aria-label="Volver a resultados">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <path d="M19 12H5M12 5l-7 7 7 7"/>
          </svg>
          Volver
        </button>
        <h2 class="anime-hero-title" id="animeTitle">—</h2>
        <div class="anime-badges" id="animeBadges"></div>
        <p class="anime-synopsis" id="animeSynopsis"></p>
        <div class="anime-genres" id="animeGenres"></div>
        <!-- acciones: favorito -->
        <div class="hero-actions-row">
          <button class="hero-fav-btn" id="heroFavBtn" type="button" onclick="favsToggleHero()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <span id="heroFavLabel">Agregar a favoritos</span>
          </button>
        </div>
        <!-- último episodio visto -->
        <div class="hero-resume-row" id="heroLastEp" style="display:none;">
          <span class="hero-resume-label">Último visto</span>
          <button class="hero-resume-btn" id="heroResumeBtn" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            Continuar — Cap. <span id="heroLastEpNum"></span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="episodes-section" aria-label="Lista de episodios">
    <div class="section-title">
      <span>Episodios</span>
      <span class="count" id="epCount"></span>
    </div>
    <div class="ep-grid" id="epGrid" role="list" aria-live="polite"></div>
  </section>

  <section id="playerSection" class="player-section" style="display:none;" aria-label="Reproductor">
    <div class="player-header">
      <div class="player-ep-label" id="playerLabel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Episodio
        <span id="extractBadge" class="extract-badge" style="display:none;"></span>
      </div>
      <div class="server-bar" id="serverBar" role="toolbar"
        aria-label="Servidores de reproducción" aria-live="polite">
        <span class="server-label">Servidores</span>
      </div>
    </div>
    <div class="player-body" id="playerBody">
      <div class="player-placeholder">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
        Selecciona un episodio para reproducir
      </div>
    </div>
  </section>

</div>

<!-- ════════════════════════════════════════
     VIEW: FAVORITOS
════════════════════════════════════════ -->
<div id="viewFavs" class="view" role="main">
  <div class="results-container">
    <div class="results-bar">
      <h2>Mis favoritos</h2>
      <div class="favs-bar-actions">
        <span class="count" id="favsCount"></span>
        <button class="btn-danger" type="button" onclick="favsClearAll()">Limpiar todo</button>
      </div>
    </div>
    <div id="favsGrid" class="results-grid" role="list" aria-live="polite"></div>
    <div id="favsEmpty" class="favs-empty" style="display:none;">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="1.5" aria-hidden="true">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
      <p>Aún no tienes animes favoritos.<br>Busca un anime y agrégalo con el botón &#9829;</p>
    </div>
  </div>
</div>

<div id="srAnnounce" role="status" aria-live="polite" class="sr-only"></div>

<script>
  const API = '';
  const state = { query:'', results:[], animeId:null, episode:null, servers:[] };
  var _currentAnimeInfo = null; // cache for history

  /* ── History (localStorage) ──────────────── */
  var HISTORY_KEY = 'joang_history';
  var HISTORY_MAX = 10;

  function historyLoad() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
    catch(e) { return []; }
  }

  function historySave(list) {
    try { localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); } catch(e) {}
  }

  // Add or move-to-front an anime. episode=null means don't override existing episode.
  function historyPush(item) {
    var list = historyLoad();
    // Remove existing entry for same id
    var filtered = [];
    var existing = null;
    for (var i = 0; i < list.length; i++) {
      if (list[i].id === item.id) { existing = list[i]; }
      else { filtered.push(list[i]); }
    }
    // Preserve existing episode if new item doesn't set one
    var episode = (item.episode != null) ? item.episode : (existing ? existing.episode : null);
    var entry = { id: item.id, title: item.title, poster: item.poster, type: item.type, rating: item.rating, episode: episode };
    filtered.unshift(entry);
    if (filtered.length > HISTORY_MAX) { filtered = filtered.slice(0, HISTORY_MAX); }
    historySave(filtered);
    historyRender();
  }

  function historyUpdateEpisode(id, episode) {
    var list = historyLoad();
    for (var i = 0; i < list.length; i++) {
      if (list[i].id === id) { list[i].episode = episode; break; }
    }
    historySave(list);
    historyRender();
  }

  function historyClear() {
    historySave([]);
    historyRender();
  }

  function historyRender() {
    var list = historyLoad();
    var section = document.getElementById('historySection');
    var grid = document.getElementById('historyGrid');
    if (!list.length) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    var html = '';
    for (var i = 0; i < list.length; i++) {
      var a = list[i];
      var epBadge = a.episode != null
        ? '<span class="history-ep-badge"><svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Cap. ' + a.episode + '</span>'
        : '';
      html += '<button class="history-card" type="button"' +
        ' aria-label="' + escA(a.title) + '"' +
        ' onclick="historyOpen(\'' + escA(a.id) + '\', ' + (a.episode != null ? a.episode : 'null') + ')">' +
        '<img class="history-card-poster" loading="lazy"' +
        ' src="' + escA(a.poster || '') + '"' +
        ' onerror="this.style.background=\'var(--surface3)\'; this.removeAttribute(\'src\')"' +
        ' alt="' + escA(a.title) + '" width="120" height="180" />' +
        '<div class="history-card-body">' +
        '<div class="history-card-title">' + esc(a.title) + '</div>' +
        epBadge +
        '</div></button>';
    }
    grid.innerHTML = html;
  }

  function historyOpen(id, episode) {
    // Navigate to anime and optionally to specific episode
    selectAnime(id, null, episode);
  }

  // Render history on load
  historyRender();

  /* ── Latest episodes / animes ───────────────── */
  function _slugToTitle(slug) {
    return (slug || '').replace(/-/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
  }

  function renderLatestEpisodes(items) {
    var section = document.getElementById('latestEpSection');
    var grid = document.getElementById('latestEpGrid');
    if (!items || !items.length) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    var html = '';
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var title = _slugToTitle(item.anime || '');
      html += '<button class="latest-ep-card" type="button"' +
        ' aria-label="' + escA(title) + ' \u2013 Episodio ' + esc(String(item.id)) + '"' +
        ' onclick="selectAnime(\'' + escA(item.anime) + '\', null, ' + Number(item.id) + ')">' +
        '<img class="latest-ep-thumb" loading="lazy"' +
        ' src="' + escA(item.image_preview || '') + '"' +
        ' onerror="this.style.background=\'var(--surface3)\'; this.removeAttribute(\'src\')"' +
        ' alt="" width="160" height="90" />' +
        '<div class="latest-ep-body">' +
        '<div class="latest-ep-title">' + esc(title) + '</div>' +
        '<div class="latest-ep-badge">Episodio ' + esc(String(item.id)) + '</div>' +
        '</div></button>';
    }
    grid.innerHTML = html;
  }

  function renderLatestAnimes(items) {
    var section = document.getElementById('latestAnimeSection');
    var grid = document.getElementById('latestAnimeGrid');
    if (!items || !items.length) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    var html = '';
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      html += '<button class="latest-anime-card" type="button"' +
        ' aria-label="' + escA(item.title || '') + '"' +
        ' onclick="selectAnime(\'' + escA(item.id) + '\', null)">' +
        '<img class="latest-anime-poster" loading="lazy"' +
        ' src="' + escA(item.poster || '') + '"' +
        ' onerror="this.style.background=\'var(--surface3)\'; this.removeAttribute(\'src\')"' +
        ' alt="' + escA(item.title || '') + '" width="112" height="168" />' +
        '<div class="latest-anime-body">' +
        '<div class="latest-anime-title">' + esc(item.title || '') + '</div>' +
        '</div></button>';
    }
    grid.innerHTML = html;
  }

  function _latestShowError(gridEl, retryFn) {
    gridEl.innerHTML =
      '<div class="latest-error">' +
      '<span class="latest-error-msg">No se pudo cargar el contenido.</span>' +
      '<button class="latest-retry-btn" type="button" onclick="(' + retryFn + ')()">' +
      '&#8635; Reintentar</button>' +
      '</div>';
  }

  function fetchLatestEpisodes() {
    var section = document.getElementById('latestEpSection');
    var grid = section.querySelector('.latest-scroll');
    section.style.display = 'block';
    grid.innerHTML = '<span class="latest-loading">Cargando\u2026</span>';
    dbgLog('INFO', '[latest/episodes] Iniciando fetch');
    fetch(API + '/latest/episodes')
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function(items) {
        if (!items || !items.length) throw new Error('0 resultados');
        dbgLog('OK', '[latest/episodes] ' + items.length + ' episodios recibidos');
        renderLatestEpisodes(items);
      })
      .catch(function(err) {
        dbgLog('ERR', '[latest/episodes] ' + (err && err.message ? err.message : 'Error desconocido'));
        _latestShowError(grid, 'fetchLatestEpisodes');
      });
  }

  function fetchLatestAnimes() {
    var section = document.getElementById('latestAnimeSection');
    var grid = section.querySelector('.latest-scroll');
    section.style.display = 'block';
    grid.innerHTML = '<span class="latest-loading">Cargando\u2026</span>';
    dbgLog('INFO', '[latest/animes] Iniciando fetch');
    fetch(API + '/latest/animes')
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function(items) {
        if (!items || !items.length) throw new Error('0 resultados');
        dbgLog('OK', '[latest/animes] ' + items.length + ' animes recibidos');
        renderLatestAnimes(items);
      })
      .catch(function(err) {
        dbgLog('ERR', '[latest/animes] ' + (err && err.message ? err.message : 'Error desconocido'));
        _latestShowError(grid, 'fetchLatestAnimes');
      });
  }

  function loadLatest() {
    // setTimeout defers until after full script eval (avoids let TDZ on _logCount)
    setTimeout(function() {
      fetchLatestEpisodes();
      fetchLatestAnimes();
    }, 0);
  }

  loadLatest();

  /* ── Favorites (localStorage) ──────────────── */
  var FAVS_KEY = 'joang_favs';

  function favsLoad() {
    try { return JSON.parse(localStorage.getItem(FAVS_KEY) || '[]'); }
    catch(e) { return []; }
  }

  function favsSave(list) {
    try { localStorage.setItem(FAVS_KEY, JSON.stringify(list)); } catch(e) {}
  }

  function favsHas(id) {
    var list = favsLoad();
    for (var i = 0; i < list.length; i++) { if (list[i].id === id) return true; }
    return false;
  }

  function favsToggle(item) {
    var list = favsLoad();
    var idx = -1;
    for (var i = 0; i < list.length; i++) { if (list[i].id === item.id) { idx = i; break; } }
    if (idx >= 0) { list.splice(idx, 1); }
    else { list.unshift({ id: item.id, title: item.title || '', poster: item.poster || '', type: item.type || '', rating: item.rating || '' }); }
    favsSave(list);
    favsUpdateHomeBtn();
    return favsHas(item.id);
  }

  function favsClearAll() {
    if (!window.confirm('¿Borrar todos los favoritos?')) return;
    favsSave([]);
    favsUpdateHomeBtn();
    favsRender();
  }

  function favsUpdateHomeBtn() {
    var has = favsLoad().length > 0;
    var homeFavBtn   = document.getElementById('homeFavBtn');
    var headerFavBtn = document.getElementById('headerFavBtn');
    if (homeFavBtn)   homeFavBtn.classList.toggle('has-favs', has);
    if (headerFavBtn) headerFavBtn.classList.toggle('has-favs', has);
  }

  // Toggle from a result/favs card fav button
  function favsToggleCard(id, btn) {
    var item = null;
    for (var i = 0; i < state.results.length; i++) {
      if (state.results[i].id === id) { item = state.results[i]; break; }
    }
    if (!item) {
      var fl = favsLoad();
      for (var j = 0; j < fl.length; j++) { if (fl[j].id === id) { item = fl[j]; break; } }
    }
    if (!item) { item = { id: id }; }
    var isFav = favsToggle(item);
    btn.classList.toggle('active', isFav);
    btn.setAttribute('aria-label', isFav ? 'Quitar de favoritos' : 'Agregar a favoritos');
    var svg = btn.querySelector('svg');
    if (svg) { svg.setAttribute('fill', isFav ? 'currentColor' : 'none'); }
    // Update hero button if this anime is currently open
    if (state.animeId === id) { favsUpdateHeroBtn(isFav); }
  }

  // Toggle from hero fav button
  function favsToggleHero() {
    if (!state.animeId) return;
    var item = { id: state.animeId, title: '', poster: '', type: '', rating: '' };
    item.title  = document.getElementById('animeTitle').textContent || '';
    item.poster = document.getElementById('animePoster').src || '';
    if (_currentAnimeInfo) {
      item.type   = _currentAnimeInfo.type   || '';
      item.rating = _currentAnimeInfo.rating || '';
    }
    var isFav = favsToggle(item);
    favsUpdateHeroBtn(isFav);
    // Also update card fav button in results if visible
    var cardFavBtn = document.querySelector('.card-fav-btn[data-anime-id="' + state.animeId + '"]');
    if (cardFavBtn) {
      cardFavBtn.classList.toggle('active', isFav);
      var svg2 = cardFavBtn.querySelector('svg');
      if (svg2) { svg2.setAttribute('fill', isFav ? 'currentColor' : 'none'); }
    }
  }

  function favsUpdateHeroBtn(isFav) {
    var btn   = document.getElementById('heroFavBtn');
    var label = document.getElementById('heroFavLabel');
    var svg   = btn ? btn.querySelector('svg') : null;
    if (!btn) return;
    btn.classList.toggle('active', isFav);
    if (label) label.textContent = isFav ? 'En favoritos' : 'Agregar a favoritos';
    if (svg)   svg.setAttribute('fill', isFav ? 'currentColor' : 'none');
  }

  function showFavs() {
    showView('viewFavs');
    favsRender();
    announce('Mis favoritos');
  }

  function favsRender() {
    var list  = favsLoad();
    var grid  = document.getElementById('favsGrid');
    var empty = document.getElementById('favsEmpty');
    var count = document.getElementById('favsCount');
    if (!list.length) {
      if (grid)  grid.innerHTML = '';
      if (empty) empty.style.display = 'block';
      if (count) count.textContent = '';
      return;
    }
    if (empty) empty.style.display = 'none';
    if (count) count.textContent = list.length + ' anime' + (list.length !== 1 ? 's' : '');
    var html = '';
    for (var i = 0; i < list.length; i++) {
      var a = list[i];
      html += '<div class="card-wrap">' +
        '<button class="anime-card" type="button" role="listitem"' +
        ' aria-label="' + escA(a.title) + '" data-id="' + escA(a.id) + '"' +
        ' onclick="selectAnime(\'' + escA(a.id) + '\', this)">' +
        '<img class="anime-card-poster" loading="lazy"' +
        ' src="' + escA(a.poster || '') + '" alt="' + escA(a.title) + '" width="160" height="240"' +
        ' onerror="this.style.background=\'var(--surface3)\'; this.removeAttribute(\'src\')" />' +
        '<div class="anime-card-body">' +
        '<div class="anime-card-title">' + esc(a.title) + '</div>' +
        '<div class="anime-card-meta">' +
        (a.type   ? '<span class="badge badge-accent">' + esc(a.type) + '</span>' : '') +
        (a.rating ? '<span class="badge badge-star">&#9733; ' + esc(a.rating) + '</span>' : '') +
        '</div></div></button>' +
        '<button class="card-fav-btn active" type="button" data-anime-id="' + escA(a.id) + '"' +
        ' aria-label="Quitar de favoritos"' +
        ' onclick="event.stopPropagation(); favsToggleCard(\'' + escA(a.id) + '\', this); favsRender();">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"' +
        ' stroke="currentColor" stroke-width="2" aria-hidden="true">' +
        '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>' +
        '</svg></button></div>';
    }
    if (grid) grid.innerHTML = html;
  }

  // Init fav indicator on page load
  favsUpdateHomeBtn();

  /* ── Playback Progress (wall-clock timer + postMessage override) ── */
  var PROG_KEY = 'joang_progress';
  var _progSaveTimer = null;

  // Wall-clock timer state
  var _epTimerInterval = null;
  var _epTimerBase     = 0;     // seconds already counted at last (re)start
  var _epTimerWall     = 0;     // Date.now() at last start/resume
  var _epTimerRunning  = false;
  var _epTimerSaveTick = 0;

  function epTimerCurrent() {
    if (!_epTimerRunning) return _epTimerBase;
    return _epTimerBase + Math.floor((Date.now() - _epTimerWall) / 1000);
  }

  function epTimerStop() {
    if (_epTimerInterval) { clearInterval(_epTimerInterval); _epTimerInterval = null; }
    _epTimerRunning = false;
    var el = document.getElementById('epTimer');
    if (el) el.textContent = '';
  }

  function epTimerPause() {
    if (!_epTimerRunning) return;
    _epTimerBase = epTimerCurrent();
    if (_epTimerInterval) { clearInterval(_epTimerInterval); _epTimerInterval = null; }
    _epTimerRunning = false;
  }

  function epTimerResume() {
    if (_epTimerRunning) return;
    _epTimerWall    = Date.now();
    _epTimerRunning = true;
    _epTimerInterval = setInterval(epTimerTick, 1000);
  }

  function epTimerBegin(savedSec) {
    epTimerStop();
    _epTimerBase     = savedSec || 0;
    _epTimerSaveTick = 0;
    epTimerResume();
  }

  function epTimerSyncFromPlayer(seconds) {
    // Called when postMessage gives us accurate video time; use it as new base
    _epTimerBase    = seconds;
    _epTimerWall    = Date.now();
    // no need to restart interval, it's already running
  }

  function epTimerTick() {
    if (!state.animeId || state.episode == null) return;
    var cur = epTimerCurrent();
    var el = document.getElementById('epTimer');
    if (el) el.textContent = formatTime(cur);
    _epTimerSaveTick++;
    if (_epTimerSaveTick % 30 === 0) {
      progSave(state.animeId, state.episode, cur, 0);
      progressUpdateEpGrid();
    }
  }

  // Pause timer when tab is hidden, resume when shown
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) { epTimerPause(); }
    else if (_epTimerInterval === null && state.animeId && state.episode != null) { epTimerResume(); }
  });

  function progStoreKey(animeId, ep) { return animeId + '::' + ep; }

  function progLoad() {
    try { return JSON.parse(localStorage.getItem(PROG_KEY) || '{}'); }
    catch(e) { return {}; }
  }

  function progGet(animeId, ep) {
    var store = progLoad();
    return store[progStoreKey(animeId, ep)] || null;
  }

  function progSave(animeId, ep, seconds, duration) {
    var store = progLoad();
    var key = progStoreKey(animeId, ep);
    var existing = store[key] || {};
    store[key] = {
      s: Math.floor(seconds),
      d: (duration > 0 ? Math.floor(duration) : (existing.d || 0)),
      t: Date.now()
    };
    try { localStorage.setItem(PROG_KEY, JSON.stringify(store)); } catch(e) {}
  }

  function progSaveDebounced(animeId, ep, seconds, duration) {
    if (_progSaveTimer) clearTimeout(_progSaveTimer);
    _progSaveTimer = setTimeout(function() {
      progSave(animeId, ep, seconds, duration);
      progressUpdateEpGrid();
    }, 3000);
  }

  function formatTime(s) {
    s = Math.floor(s || 0);
    var m = Math.floor(s / 60);
    var sec = s % 60;
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  }

  function progressUpdateEpGrid() {
    if (!state.animeId) return;
    document.querySelectorAll('.ep-btn').forEach(function(btn) {
      var label = btn.getAttribute('aria-label') || '';
      var match = label.match(/Episodio (\d+)/);
      if (!match) return;
      var ep = parseInt(match[1]);
      var prog = progGet(state.animeId, ep);
      var oldBar = btn.querySelector('.ep-btn-progress');
      if (oldBar) oldBar.parentNode.removeChild(oldBar);
      if (!prog || prog.s < 3) return;
      btn.classList.add('has-progress');
      var bar = document.createElement('span');
      bar.className = 'ep-btn-progress';
      var pct = (prog.d > 0) ? Math.min(100, Math.round(prog.s / prog.d * 100)) : 25;
      bar.style.width = pct + '%';
      btn.title = 'Visto hasta ' + formatTime(prog.s) + (prog.d > 0 ? ' / ' + formatTime(prog.d) : '');
      btn.appendChild(bar);
    });
  }

  // Catch time events from cross-origin iframe players via postMessage
  // Compatible with: JWPlayer, Plyr, Video.js and generic HTML5 player wrappers
  window.addEventListener('message', function(evt) {
    if (!state.animeId || state.episode === null) return;
    var data = evt.data;
    if (typeof data === 'string') {
      if (data.indexOf('{') === -1) return;
      try { data = JSON.parse(data); } catch(e) { return; }
    }
    if (!data || typeof data !== 'object') return;
    var seconds = null;
    var duration = 0;
    // JWPlayer: { event:'time', position:x, duration:y }
    if (data.event === 'time' && typeof data.position === 'number') {
      seconds = data.position; duration = data.duration || 0;
    }
    // Plyr: { source:'plyr', event:'timeupdate', value:x }
    else if (data.source === 'plyr' && data.event === 'timeupdate' && typeof data.value === 'number') {
      seconds = data.value;
    }
    // Video.js / generic: { event|type:'timeupdate', currentTime:x }
    else if ((data.event === 'timeupdate' || data.type === 'timeupdate') && typeof data.currentTime === 'number') {
      seconds = data.currentTime; duration = data.duration || 0;
    }
    // Generic loose formats
    else if (typeof data.currentTime === 'number' && data.currentTime > 0) {
      seconds = data.currentTime; duration = data.duration || 0;
    }
    else if (typeof data.position === 'number' && data.position > 0) {
      seconds = data.position; duration = data.duration || 0;
    }
    else if (typeof data.time === 'number' && data.time > 0) {
      seconds = data.time; duration = data.total || data.duration || 0;
    }
    if (seconds !== null && seconds > 3) {
      // Sync wall-clock base to accurate player time
      epTimerSyncFromPlayer(seconds);
      progSaveDebounced(state.animeId, state.episode, seconds, duration);
    }
  });


  var _toastTimer = null;

  function progressShowToast(seconds, duration) {
    var existing = document.getElementById('progressToast');
    if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
    if (_toastTimer) clearTimeout(_toastTimer);
    var pct = (duration > 0) ? Math.min(100, Math.round(seconds / duration * 100)) : 0;
    var pctStr = pct > 0 ? pct + '% visto' : formatTime(seconds) + ' registrados';
    var pctBar = pct > 0
      ? '<div class="toast-progress-bar-wrap"><div class="toast-progress-bar" style="width:' + pct + '%"></div></div>'
      : '';
    var toast = document.createElement('div');
    toast.id = 'progressToast';
    toast.className = 'progress-toast';
    toast.setAttribute('role', 'status');
    toast.innerHTML =
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
      '<div style="flex:1"><div class="toast-msg"><strong>' + pctStr + '</strong> en este episodio</div>' + pctBar + '</div>' +
      '<button class="toast-close" type="button" aria-label="Cerrar" onclick="progressToastClose()">\u2715</button>';
    document.body.appendChild(toast);
    _toastTimer = setTimeout(progressToastClose, 6000);
  }

  function progressToastClose() {
    var t = document.getElementById('progressToast');
    if (t) {
      t.style.opacity = '0';
      t.style.transform = 'translateX(-50%) translateY(14px)';
      setTimeout(function() { if (t.parentNode) t.parentNode.removeChild(t); }, 240);
    }
    if (_toastTimer) clearTimeout(_toastTimer);
  }

  /* ── Debug log ─────────────────────────────── */
  let _logCount = 0;
  function dbgLog(level, msg) {
    _logCount++;
    document.getElementById('debugBadge').textContent = _logCount;
    const log = document.getElementById('debugLog');
    const now = new Date();
    const ts = now.toTimeString().slice(0, 8);
    const cls = level === 'OK' ? 'log-ok' : level === 'WARN' ? 'log-warn' : level === 'ERR' ? 'log-err' : 'log-info';
    const line = document.createElement('div');
    line.className = 'log-line';
    line.innerHTML = `<span class="log-ts">${ts}</span><span class="log-lvl ${cls}">${level}</span><span class="log-msg">${msg}</span>`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
    // Auto-expand on warnings/errors
    if ((level === 'WARN' || level === 'ERR') && !document.getElementById('debugLog').classList.contains('open')) {
      toggleDebug();
    }
  }
  function toggleDebug() {
    const log = document.getElementById('debugLog');
    const btn = document.getElementById('debugToggle');
    const open = log.classList.toggle('open');
    btn.classList.toggle('open', open);
    btn.setAttribute('aria-expanded', open);
  }

  /* ── Helpers ───────────────────────────────── */
  function esc(s)  { return String(s == null ? '' : s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function escA(s) { return String(s == null ? '' : s).replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function parseErr(e) {
    try {
      var parsed = JSON.parse(e.message);
      return (parsed && parsed.detail) ? parsed.detail : e.message;
    } catch(ex) { return e.message; }
  }
  function announce(msg) {
    const el = document.getElementById('srAnnounce');
    el.textContent = '';
    requestAnimationFrame(() => el.textContent = msg);
  }

  /* ── Views ─────────────────────────────────── */
  // display values per view — must be set via style to beat CSS ID-selector specificity
  const VIEW_DISPLAY = { viewHome: 'flex', viewResults: 'flex', viewAnime: 'block', viewFavs: 'flex' };
  var _currentView = 'viewHome';

  function showView(id) {
    _currentView = id;
    Object.keys(VIEW_DISPLAY).forEach(v => {
      const el = document.getElementById(v);
      el.style.display = v === id ? VIEW_DISPLAY[v] : 'none';
      el.classList.toggle('active', v === id);
    });
    document.getElementById('siteHeader').style.display = id === 'viewHome' ? 'none' : 'flex';
    try { window.scrollTo({ top: 0, behavior: 'instant' }); } catch(e) { window.scrollTo(0, 0); }
  }

  function goHome() {
    showView('viewHome');
    setTimeout(() => document.getElementById('homeInput').focus(), 50);
  }

  function goBack() {
    showView(_backView || 'viewHome');
    if ((_backView || 'viewHome') === 'viewResults') {
      requestAnimationFrame(() => {
        const active = document.querySelector('.anime-card.active');
        if (active) active.focus();
      });
    }
  }

  /* ── Search ────────────────────────────────── */
  async function doSearch(query) {
    query = (query || '').trim();
    if (!query) return;
    state.query = query;

    showView('viewResults');
    document.getElementById('resultsTitle').textContent = '"' + query + '"';
    document.getElementById('resultsCount').textContent = '';
    document.getElementById('resultsGrid').innerHTML =
      '<div class="empty-msg" style="grid-column:1/-1"><span class="spinner" aria-hidden="true"></span>&nbsp;Buscando…</div>';

    document.getElementById('headerInput').value = query;
    document.getElementById('homeInput').value   = query;

    ['homeBtn','headerBtn'].forEach(id => setBtnLoading(id, true));
    announce('Buscando ' + query + '…');

    const t0 = performance.now();
    dbgLog('INFO', `Buscando: "${query}"`);
    try {
      const res = await fetch(`${API}/search?query=${encodeURIComponent(query)}`);
      const elapsed = Math.round(performance.now() - t0);
      if (!res.ok) {
        const detail = await res.text();
        dbgLog('ERR', `HTTP ${res.status} en ${elapsed}ms — ${detail}`);
        throw new Error(detail);
      }
      const data = await res.json();
      state.results = data;
      if (data.length === 0) {
        dbgLog('WARN', `Sin resultados para "${query}" (${elapsed}ms) — Posible bloqueo de Cloudflare. Intenta de nuevo.`);
      } else {
        dbgLog('OK', `${data.length} resultado${data.length!==1?'s':''} para "${query}" en ${elapsed}ms`);
      }
      renderGrid(data);
      announce(data.length ? `${data.length} resultados para ${query}` : `Sin resultados para ${query}`);
    } catch(e) {
      const elapsed = Math.round(performance.now() - t0);
      dbgLog('ERR', `Error en ${elapsed}ms — ${parseErr(e)}`);
      document.getElementById('resultsGrid').innerHTML =
        `<div class="error-box" role="alert" style="grid-column:1/-1">Error al buscar: ${esc(parseErr(e))}</div>`;
      announce('Error al buscar');
    } finally {
      ['homeBtn','headerBtn'].forEach(id => setBtnLoading(id, false));
    }
  }

  function setBtnLoading(id, on) {
    const b = document.getElementById(id);
    if (!b) return;
    b.disabled = on;
    b.textContent = on ? '' : 'Buscar';
    if (on) { const s = document.createElement('span'); s.className = 'spinner'; s.setAttribute('aria-hidden','true'); b.appendChild(s); }
  }

  function renderGrid(animes) {
    const count = document.getElementById('resultsCount');
    if (!animes.length) {
      count.textContent = '';
      document.getElementById('resultsGrid').innerHTML =
        '<div class="empty-msg" style="grid-column:1/-1">Sin resultados para esta búsqueda.</div>';
      return;
    }
    count.textContent = `${animes.length} resultado${animes.length !== 1 ? 's' : ''}`;
    var html = '';
    for (var ri = 0; ri < animes.length; ri++) {
      var a = animes[ri];
      var isFav = favsHas(a.id);
      var heartFill = isFav ? 'currentColor' : 'none';
      html += '<div class="card-wrap">' +
        '<button class="anime-card" type="button" role="listitem"' +
        ' aria-label="' + escA(a.title) + '" data-id="' + escA(a.id) + '"' +
        ' onclick="selectAnime(\'' + escA(a.id) + '\', this)">' +
        '<img class="anime-card-poster" loading="lazy"' +
        ' src="' + escA(a.poster || '') + '"' +
        ' onerror="this.style.background=\'var(--surface3)\'; this.removeAttribute(\'src\')"' +
        ' alt="' + escA(a.title) + '" width="160" height="240" />' +
        '<div class="anime-card-body">' +
        '<div class="anime-card-title">' + esc(a.title) + '</div>' +
        '<div class="anime-card-meta">' +
        (a.type   ? '<span class="badge badge-accent">' + esc(a.type) + '</span>' : '') +
        (a.rating ? '<span class="badge badge-star">&#9733; ' + esc(a.rating) + '</span>' : '') +
        (a.debut  ? '<span class="badge badge-surface">' + esc(a.debut) + '</span>' : '') +
        '</div></div></button>' +
        '<button class="card-fav-btn' + (isFav ? ' active' : '') + '" type="button"' +
        ' data-anime-id="' + escA(a.id) + '"' +
        ' aria-label="' + (isFav ? 'Quitar de favoritos' : 'Agregar a favoritos') + '"' +
        ' onclick="event.stopPropagation(); favsToggleCard(\'' + escA(a.id) + '\', this)">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="' + heartFill + '"' +
        ' stroke="currentColor" stroke-width="2" aria-hidden="true">' +
        '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>' +
        '</svg></button></div>';
    }
    document.getElementById('resultsGrid').innerHTML = html;
  }

  /* ── Anime detail ──────────────────────────── */
  var _backView = 'viewHome';

  async function selectAnime(id, el, targetEp) {
    // Remember which view we came from so goBack() returns to the right place
    _backView = _currentView !== 'viewAnime' ? _currentView : _backView;

    targetEp = targetEp != null ? targetEp : null;
    document.querySelectorAll('.anime-card').forEach(c => c.classList.remove('active'));
    if (el) el.classList.add('active');

    state.animeId   = id;
    state.episode   = null;
    state.servers   = [];

    showView('viewAnime');
    document.getElementById('animeTitle').textContent  = '…';
    document.getElementById('animeSynopsis').textContent = '';
    document.getElementById('animeBadges').innerHTML   = '';
    document.getElementById('animeGenres').innerHTML   = '';
    document.getElementById('animePoster').src         = '';
    document.getElementById('animeBg').style.backgroundImage = '';
    document.getElementById('epCount').textContent     = '';
    document.getElementById('epGrid').innerHTML =
      '<div class="empty-msg" style="width:100%"><span class="spinner" aria-hidden="true"></span>&nbsp;Cargando episodios…</div>';
    document.getElementById('playerSection').style.display = 'none';
    announce('Cargando información del anime…');

    try {
      const res = await fetch(`${API}/anime/${encodeURIComponent(id)}`);
      if (!res.ok) throw new Error(await res.text());
      const info = await res.json();
      _currentAnimeInfo = info;
      renderHero(info);
      renderEpGrid(info.episodes || []);
      // Save to history (without episode — will be updated when one plays)
      historyPush({ id: id, title: info.title || '', poster: info.poster || '', type: info.type || '', rating: info.rating || '', episode: null });
      announce(`${info.title} — ${(info.episodes||[]).length} episodios`);
      // If coming from history with a target episode, scroll to it
      if (targetEp != null) {
        var btn = document.querySelector('.ep-btn[aria-label="Episodio ' + targetEp + '"]');
        if (btn) { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); btn.focus(); }
      }
    } catch(e) {
      document.getElementById('animeTitle').textContent = 'Error al cargar el anime';
      document.getElementById('epGrid').innerHTML = `<div class="error-box" role="alert">${esc(parseErr(e))}</div>`;
      announce('Error al cargar el anime');
    }
  }

  function renderHero(info) {
    const poster = info.poster || '';
    document.getElementById('animePoster').src = poster;
    document.getElementById('animePoster').alt = info.title || '';
    document.getElementById('animeBg').style.backgroundImage = poster ? `url("${escA(poster)}")` : '';
    document.getElementById('animeTitle').textContent      = info.title || '—';
    document.getElementById('animeSynopsis').textContent   = info.synopsis || '';
    document.getElementById('animeBadges').innerHTML = [
      info.type   ? `<span class="badge badge-accent">${esc(info.type)}</span>` : '',
      info.rating ? `<span class="badge badge-star">&#9733; ${esc(info.rating)}</span>` : '',
      info.debut  ? `<span class="badge badge-surface">${esc(info.debut)}</span>` : '',
    ].join('');
    document.getElementById('animeGenres').innerHTML = (info.genres||[])
      .map(g => `<span class="badge badge-surface">${esc(g)}</span>`).join('');

    // Show last watched episode if present in history
    var hlist = historyLoad();
    var histEntry = null;
    for (var i = 0; i < hlist.length; i++) {
      if (hlist[i].id === state.animeId) { histEntry = hlist[i]; break; }
    }
    var heroLastEp = document.getElementById('heroLastEp');
    if (histEntry && histEntry.episode != null) {
      document.getElementById('heroLastEpNum').textContent = histEntry.episode;
      var resumeEp = histEntry.episode;
      document.getElementById('heroResumeBtn').onclick = function() {
        var btn = document.querySelector('.ep-btn[aria-label="Episodio ' + resumeEp + '"]');
        if (btn) { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        selectEpisode(resumeEp, btn || document.querySelector('.ep-btn'));
      };
      heroLastEp.style.display = 'flex';
    } else {
      heroLastEp.style.display = 'none';
    }
    // Sync hero fav button
    favsUpdateHeroBtn(favsHas(state.animeId));
  }

  function renderEpGrid(episodes) {
    document.getElementById('epCount').textContent =
      episodes.length ? `${episodes.length} episodio${episodes.length!==1?'s':''}` : '';

    if (!episodes.length) {
      document.getElementById('epGrid').innerHTML =
        '<span style="color:var(--muted);font-size:var(--fs-sm)">Sin episodios disponibles.</span>';
      return;
    }
    document.getElementById('epGrid').innerHTML = episodes.map(ep => `
      <button class="ep-btn" type="button" role="listitem"
        aria-label="Episodio ${Number(ep.id)}" aria-pressed="false"
        onclick="selectEpisode(${Number(ep.id)}, this)">${ep.id}</button>
    `).join('');
    // Draw progress bars after DOM is ready
    requestAnimationFrame(progressUpdateEpGrid);
  }

  /* ── Episode & servers ─────────────────────── */
  async function selectEpisode(ep, el) {
    if (!state.animeId) return;
    document.querySelectorAll('.ep-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    el.classList.add('active'); el.setAttribute('aria-pressed','true');
    state.episode = ep;

    const dubbed = document.getElementById('dubbedCheck').checked;
    const pSection = document.getElementById('playerSection');
    pSection.style.display = 'block';
    document.getElementById('playerLabel').innerHTML =
      `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg> Episodio ${ep}<span id="epTimer" class="ep-timer"></span>`;
    document.getElementById('serverBar').innerHTML =
      `<span class="server-label">Servidores</span>&nbsp;<span class="spinner" aria-hidden="true"></span>`;
    setPlayerBody('<div class="player-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Cargando…</div>');
    pSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    announce(`Cargando episodio ${ep}…`);

    try {
      const res = await fetch(`${API}/anime/${encodeURIComponent(state.animeId)}/episode/${ep}/servers?dubbed=${dubbed}`);
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      state.servers = [].concat.apply([], data);

      if (!state.servers.length) {
        document.getElementById('serverBar').innerHTML =
          '<span style="color:var(--muted);font-size:var(--fs-sm)">No hay servidores disponibles.</span>';
        setPlayerBody('<div class="player-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Sin servidores disponibles.</div>');
        announce('Sin servidores disponibles');
        return;
      }

      renderServerBar(state.servers);
      loadServer(state.servers[0]);
      // Update last watched episode in history
      historyUpdateEpisode(state.animeId, ep);
      // Show progress toast if there's saved progress for this episode
      (function(aId, epNum) {
        var prog = progGet(aId, epNum);
        if (prog && prog.s > 10) {
          setTimeout(function() { progressShowToast(prog.s, prog.d || 0); }, 1800);
        }
      }(state.animeId, ep));
      // Update hero indicator live
      (function(resumeEp) {
        var heroLastEp = document.getElementById('heroLastEp');
        var heroNum    = document.getElementById('heroLastEpNum');
        if (heroLastEp && heroNum) {
          heroNum.textContent = resumeEp;
          document.getElementById('heroResumeBtn').onclick = function() {
            var btn = document.querySelector('.ep-btn[aria-label="Episodio ' + resumeEp + '"]');
            if (btn) { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            selectEpisode(resumeEp, btn || document.querySelector('.ep-btn'));
          };
          heroLastEp.style.display = 'flex';
        }
      }(ep));
      announce(`${state.servers.length} servidores — reproduciendo en ${state.servers[0].title||'Servidor 1'}`);
    } catch(e) {
      document.getElementById('serverBar').innerHTML =
        `<div class="error-box" role="alert">Error: ${esc(parseErr(e))}</div>`;
      announce('Error al cargar servidores');
    }
  }

  function renderServerBar(servers) {
    // Reset extraction badge
    var badge = document.getElementById('extractBadge');
    if (badge) { badge.style.display = 'none'; badge.textContent = ''; }
    document.getElementById('serverBar').innerHTML =
      `<span class="server-label" aria-hidden="true">Servidores</span>` +
      servers.map((s,i) =>
        `<button class="server-btn${i===0?' active':''}" type="button"
          aria-pressed="${i===0}"
          aria-label="Reproducir en ${escA(s.title||s.server||`Servidor ${i+1}`)}"
          onclick="pickServer(${i},this)"
        >${esc(s.title||s.server||`Servidor ${i+1}`)}</button>`
      ).join('');
  }

  function pickServer(idx, el) {
    document.querySelectorAll('.server-btn').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
    el.classList.add('active'); el.setAttribute('aria-pressed','true');
    loadServer(state.servers[idx]);
    announce(`Cargando ${el.textContent.trim()}…`);
  }

  var _hlsInstance = null;

  function _initHls(url, video) {
    if (_hlsInstance) { try { _hlsInstance.destroy(); } catch(e) {} _hlsInstance = null; }
    if (window.Hls && window.Hls.isSupported()) {
      _hlsInstance = new window.Hls({ enableWorker: true, lowLatencyMode: false });
      _hlsInstance.on(window.Hls.Events.ERROR, function(event, data) {
        if (data.fatal) {
          dbgLog('WARN', '[hls] Error fatal: ' + data.type + ' / ' + data.details);
          // destroy to free resources; player will show native error
          _hlsInstance.destroy();
          _hlsInstance = null;
        }
      });
      _hlsInstance.loadSource(url);
      _hlsInstance.attachMedia(video);
      _hlsInstance.on(window.Hls.Events.MANIFEST_PARSED, function() {
        video.play().catch(function() {});
      });
    } else {
      video.src = url;
    }
  }

  function _loadHLS(url, video) {
    if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = url; return; }
    if (window.Hls) { _initHls(url, video); return; }
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1/dist/hls.min.js';
    s.onload = function() { _initHls(url, video); };
    s.onerror = function() { video.src = url; };
    document.head.appendChild(s);
  }

  function loadDirectVideo(url, ext, savedSec) {
    epTimerStop(); // real video events handle tracking
    var isHLS = ext === 'm3u8' || url.indexOf('.m3u8') !== -1;
    setPlayerBody('<video id="directPlayer" class="direct-player" controls autoplay playsinline></video>');
    var video = document.getElementById('directPlayer');

    if (savedSec > 10) {
      video.addEventListener('loadedmetadata', function() {
        video.currentTime = savedSec;
        progressShowToast(savedSec, video.duration || 0);
      }, { once: true });
    }

    // Save progress every ~5s
    var _vidTick = 0;
    video.addEventListener('timeupdate', function() {
      _vidTick++;
      if (_vidTick % 20 !== 0) return; // timeupdate fires ~4x/s → save every ~5s
      if (!state.animeId || state.episode == null) return;
      var cur = Math.floor(video.currentTime);
      var dur = Math.floor(video.duration || 0);
      if (cur < 2) return;
      progSave(state.animeId, state.episode, cur, dur);
      progressUpdateEpGrid();
      var timerEl = document.getElementById('epTimer');
      if (timerEl) timerEl.textContent = formatTime(cur);
    });

    // Route HLS streams through the server proxy to avoid CORS issues with CDN hosts
    var finalUrl = url;
    if (isHLS && url.startsWith('http')) {
      finalUrl = API + '/proxy?url=' + encodeURIComponent(url);
      dbgLog('INFO', '[player] Usando proxy para HLS: ' + url.slice(0, 70));
    }
    if (isHLS) { _loadHLS(finalUrl, video); } else { video.src = finalUrl; }
  }

  function loadServer(s) {
    const src = s.code || s.url || '';
    if (!src) { setPlayerBody('<div class="player-placeholder">No se pudo obtener la URL del servidor.</div>'); return; }
    if (_progSaveTimer) { clearTimeout(_progSaveTimer); _progSaveTimer = null; }
    var savedProg = (state.animeId && state.episode != null) ? progGet(state.animeId, state.episode) : null;
    var savedSec = savedProg ? savedProg.s : 0;

    setPlayerBody('<div class="player-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>Extrayendo enlace directo\u2026</div>');
    dbgLog('INFO', '[extract] Intentando extraer: ' + src.slice(0, 70));

    fetch(API + '/extract?url=' + encodeURIComponent(src))
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function(data) {
        if (!data.url) throw new Error('Sin URL en respuesta');
        var label = '\u25CF Directo' + (data.height ? ' ' + data.height + 'p' : '') + (data.ext ? ' (' + data.ext + ')' : '');
        dbgLog('OK', '[extract] ' + label + ' \u2014 ' + data.url.slice(0, 70));
        var badge = document.getElementById('extractBadge');
        if (badge) { badge.textContent = label; badge.className = 'extract-badge'; badge.style.display = 'inline-flex'; }
        loadDirectVideo(data.url, data.ext, savedSec);
      })
      .catch(function(err) {
        dbgLog('WARN', '[extract] Fall\u00f3 (' + (err.message || err) + '), usando iframe');
        var badge = document.getElementById('extractBadge');
        if (badge) { badge.textContent = 'Iframe'; badge.className = 'extract-badge fallback'; badge.style.display = 'inline-flex'; }
        epTimerBegin(savedSec);
        setPlayerBody(`<iframe src="${escA(src)}" title="Reproductor de video"
      allowfullscreen scrolling="no"
      allow="autoplay; encrypted-media; fullscreen"
      sandbox="allow-scripts allow-same-origin allow-forms allow-presentation"
    ></iframe>`);
      });
  }

  function setPlayerBody(html) { document.getElementById('playerBody').innerHTML = html; }

  /* ── Dubbed change ─────────────────────────── */
  document.getElementById('dubbedCheck').addEventListener('change', () => {
    if (state.episode !== null) {
      const btn = document.querySelector('.ep-btn.active');
      if (btn) selectEpisode(state.episode, btn);
    }
  });
</script>
</body>
</html>
